# REFERRAL_SYSTEM.md ‚Äî –†–µ—Ñ–µ—Ä–∞–ª—å–Ω–∞—è –ø—Ä–æ–≥—Ä–∞–º–º–∞

–î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è —Ä–µ—Ñ–µ—Ä–∞–ª—å–Ω–æ–π —Å–∏—Å—Ç–µ–º—ã.

---

## –°–æ–¥–µ—Ä–∂–∞–Ω–∏–µ

1. [–ö–∞–∫ —Ä–∞–±–æ—Ç–∞–µ—Ç —Ä–µ—Ñ–µ—Ä–∞–ª—å–Ω–∞—è –ø—Ä–æ–≥—Ä–∞–º–º–∞](#–∫–∞–∫-—Ä–∞–±–æ—Ç–∞–µ—Ç-—Ä–µ—Ñ–µ—Ä–∞–ª—å–Ω–∞—è-–ø—Ä–æ–≥—Ä–∞–º–º–∞)
2. [–ì–µ–Ω–µ—Ä–∞—Ü–∏—è —Ä–µ—Ñ–µ—Ä–∞–ª—å–Ω–æ–π —Å—Å—ã–ª–∫–∏](#–≥–µ–Ω–µ—Ä–∞—Ü–∏—è-—Ä–µ—Ñ–µ—Ä–∞–ª—å–Ω–æ–π-—Å—Å—ã–ª–∫–∏)
3. [–ù–∞—á–∏—Å–ª–µ–Ω–∏–µ –±–æ–Ω—É—Å–æ–≤](#–Ω–∞—á–∏—Å–ª–µ–Ω–∏–µ-–±–æ–Ω—É—Å–æ–≤)
4. [–ó–∞—â–∏—Ç–∞ –æ—Ç —Ñ—Ä–æ–¥–∞](#–∑–∞—â–∏—Ç–∞-–æ—Ç-—Ñ—Ä–æ–¥–∞)
5. [–¢–∞–±–ª–∏—Ü—ã –≤ Supabase](#—Ç–∞–±–ª–∏—Ü—ã-–≤-supabase)
6. [–ü—Ä–∏–º–µ—Ä—ã –∫–æ–¥–∞](#–ø—Ä–∏–º–µ—Ä—ã-–∫–æ–¥–∞)

---

## –ö–∞–∫ —Ä–∞–±–æ—Ç–∞–µ—Ç —Ä–µ—Ñ–µ—Ä–∞–ª—å–Ω–∞—è –ø—Ä–æ–≥—Ä–∞–º–º–∞

### –û–±—â–∞—è —Å—Ö–µ–º–∞

```
–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å A (—Ä–µ—Ñ–µ—Ä–µ—Ä)
        ‚îÇ
        ‚îú‚îÄ‚îÄ –ò–º–µ–µ—Ç —Ä–µ—Ñ–µ—Ä–∞–ª—å–Ω—ã–π –∫–æ–¥: NAT1001
        ‚îÇ
        ‚îî‚îÄ‚îÄ –î–µ–ª–∏—Ç—Å—è —Å—Å—ã–ª–∫–æ–π: https://app.com/el/register?ref=NAT1001
                ‚îÇ
                ‚ñº
–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å B –ø–µ—Ä–µ—Ö–æ–¥–∏—Ç –ø–æ —Å—Å—ã–ª–∫–µ
        ‚îÇ
        ‚îú‚îÄ‚îÄ –†–µ–≥–∏—Å—Ç—Ä–∏—Ä—É–µ—Ç—Å—è —Å referred_by = "NAT1001"
        ‚îÇ
        ‚îî‚îÄ‚îÄ –ü–æ–∫—É–ø–∞–µ—Ç –∞–∫–∫–∞—É–Ω—Ç (‚Ç¨62)
                ‚îÇ
                ‚ñº
–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å A –ø–æ–ª—É—á–∞–µ—Ç +1 –±–æ–Ω—É—Å–Ω—ã–π –º–µ—Å—è—Ü
```

### –£—Å–ª–æ–≤–∏—è —É—á–∞—Å—Ç–∏—è

| –î–µ–π—Å—Ç–≤–∏–µ | –¢—Ä–µ–±–æ–≤–∞–Ω–∏–µ |
|----------|------------|
| **–ò–º–µ—Ç—å —Ä–µ—Ñ–µ—Ä–∞–ª—å–Ω—ã–π –∫–æ–¥** | –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø—Ä–∏ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏ |
| **–ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å —Ä–µ—Ñ–µ—Ä–∞–ª—å–Ω—É—é –ø—Ä–æ–≥—Ä–∞–º–º—É** | `account_purchased = true` (–ø–ª–∞—Ç–Ω—ã–π –∞–∫–∫–∞—É–Ω—Ç) |
| **–ü–æ–ª—É—á–∏—Ç—å –±–æ–Ω—É—Å** | –ü—Ä–∏–≥–ª–∞—à—ë–Ω–Ω—ã–π –∫—É–ø–∏–ª –∞–∫–∫–∞—É–Ω—Ç |

### –î–æ—Å—Ç—É–ø–Ω–æ—Å—Ç—å –ø–æ —Ç–∞—Ä–∏—Ñ–∞–º

| –¢–∞—Ä–∏—Ñ | –†–µ—Ñ–µ—Ä–∞–ª—å–Ω–∞—è –ø—Ä–æ–≥—Ä–∞–º–º–∞ |
|-------|----------------------|
| DEMO | ‚ùå –ù–µ–¥–æ—Å—Ç—É–ø–Ω–∞ |
| Basic | ‚úÖ –î–æ—Å—Ç—É–ø–Ω–∞ |
| Standard | ‚úÖ –î–æ—Å—Ç—É–ø–Ω–∞ |
| Premium | ‚úÖ –î–æ—Å—Ç—É–ø–Ω–∞ |
| VIP | ‚úÖ –î–æ—Å—Ç—É–ø–Ω–∞ |

---

## –ì–µ–Ω–µ—Ä–∞—Ü–∏—è —Ä–µ—Ñ–µ—Ä–∞–ª—å–Ω–æ–π —Å—Å—ã–ª–∫–∏

### –§–æ—Ä–º–∞—Ç —Ä–µ—Ñ–µ—Ä–∞–ª—å–Ω–æ–≥–æ –∫–æ–¥–∞

```
[3 –±—É–∫–≤—ã –∏–º–µ–Ω–∏] + [account_number]

–ü—Ä–∏–º–µ—Ä—ã:
- –ù–∞—Ç–∞–ª—å—è #1001 ‚Üí NAT1001
- John #1002 ‚Üí JOH1002
- ŒëŒªŒ≠ŒæŒ±ŒΩŒ¥œÅŒøœÇ #1003 ‚Üí ŒëŒõŒï1003
```

### –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –∫–æ–¥–∞ (—Ç—Ä–∏–≥–≥–µ—Ä Supabase)

```sql
-- –§—É–Ω–∫—Ü–∏—è –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –∫–æ–¥–∞
CREATE OR REPLACE FUNCTION generate_referral_code(user_name TEXT, acc_number INTEGER)
RETURNS TEXT AS $$
DECLARE
  prefix TEXT;
BEGIN
  -- –ü–µ—Ä–≤—ã–µ 3 –±—É–∫–≤—ã –∏–º–µ–Ω–∏ (uppercase)
  prefix := UPPER(LEFT(COALESCE(user_name, 'USR'), 3));
  RETURN prefix || acc_number::TEXT;
END;
$$ LANGUAGE plpgsql;

-- –¢—Ä–∏–≥–≥–µ—Ä –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
CREATE OR REPLACE FUNCTION handle_new_user()
RETURNS TRIGGER AS $$
BEGIN
  INSERT INTO profiles (id, email, name, referral_code, referred_by, demo_expires_at)
  VALUES (
    NEW.id,
    NEW.email,
    NEW.raw_user_meta_data->>'name',
    generate_referral_code(
      NEW.raw_user_meta_data->>'name',
      (SELECT COALESCE(MAX(account_number), 1000) + 1 FROM profiles)
    ),
    NEW.raw_user_meta_data->>'referred_by',
    NOW() + INTERVAL '48 hours'
  );
  RETURN NEW;
END;
$$ LANGUAGE plpgsql;

CREATE TRIGGER on_auth_user_created
  AFTER INSERT ON auth.users
  FOR EACH ROW
  EXECUTE FUNCTION handle_new_user();
```

### –§–æ—Ä–º–∞—Ç —Ä–µ—Ñ–µ—Ä–∞–ª—å–Ω–æ–π —Å—Å—ã–ª–∫–∏

```
https://apallaktis.com/{locale}/register?ref={referral_code}

–ü—Ä–∏–º–µ—Ä—ã:
https://apallaktis.com/el/register?ref=NAT1001
https://apallaktis.com/ru/register?ref=JOH1002
```

---

## –ù–∞—á–∏—Å–ª–µ–Ω–∏–µ –±–æ–Ω—É—Å–æ–≤

### –ö–æ–≥–¥–∞ –Ω–∞—á–∏—Å–ª—è–µ—Ç—Å—è –±–æ–Ω—É—Å

1. –ü—Ä–∏–≥–ª–∞—à—ë–Ω–Ω—ã–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä—É–µ—Ç—Å—è —Å —Ä–µ—Ñ–µ—Ä–∞–ª—å–Ω—ã–º –∫–æ–¥–æ–º
2. –ü—Ä–∏–≥–ª–∞—à—ë–Ω–Ω—ã–π –ø–æ–∫—É–ø–∞–µ—Ç –∞–∫–∫–∞—É–Ω—Ç (‚Ç¨62)
3. Webhook `checkout.session.completed` –ø–æ–ª—É—á–µ–Ω
4. –ü—Ä–æ–≤–µ—Ä–∫–∏ –∞–Ω—Ç–∏-—Ñ—Ä–æ–¥–∞ –ø—Ä–æ–π–¥–µ–Ω—ã
5. –†–µ—Ñ–µ—Ä–µ—Ä—É –Ω–∞—á–∏—Å–ª—è–µ—Ç—Å—è **+1 –º–µ—Å—è—Ü**

### –ó–Ω–∞—á–µ–Ω–∏–µ –±–æ–Ω—É—Å–∞

- **+1 –±–µ—Å–ø–ª–∞—Ç–Ω—ã–π –º–µ—Å—è—Ü** –∑–∞ –∫–∞–∂–¥–æ–≥–æ –ø—Ä–∏–≥–ª–∞—à—ë–Ω–Ω–æ–≥–æ, –∫–æ—Ç–æ—Ä—ã–π –∫—É–ø–∏–ª –∞–∫–∫–∞—É–Ω—Ç
- –ë–æ–Ω—É—Å—ã –Ω–∞–∫–∞–ø–ª–∏–≤–∞—é—Ç—Å—è –≤ –ø–æ–ª–µ `bonus_months`
- –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –∏—Å–ø–æ–ª—å–∑—É—é—Ç—Å—è –ø—Ä–∏ —Å–ª–µ–¥—É—é—â–µ–º –ø–ª–∞—Ç–µ–∂–µ

### –ü—Ä–æ—Ü–µ—Å—Å –Ω–∞—á–∏—Å–ª–µ–Ω–∏—è

```typescript
async function rewardReferrer(newUserId: string, paymentAmount: number) {
  // 1. –ü–æ–ª—É—á–∏—Ç—å –¥–∞–Ω–Ω—ã–µ –Ω–æ–≤–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
  const { data: newUser } = await supabase
    .from('profiles')
    .select('email, referred_by')
    .eq('id', newUserId)
    .single();

  if (!newUser?.referred_by) return;

  // 2. –ù–∞–π—Ç–∏ —Ä–µ—Ñ–µ—Ä–µ—Ä–∞
  const { data: referrer } = await supabase
    .from('profiles')
    .select('*')
    .eq('referral_code', newUser.referred_by)
    .single();

  if (!referrer) return;

  // 3. –ê–Ω—Ç–∏-—Ñ—Ä–æ–¥ –ø—Ä–æ–≤–µ—Ä–∫–∏
  if (!validateReferral(referrer, newUser, paymentAmount)) {
    console.warn('Referral validation failed');
    return;
  }

  // 4. –ù–∞—á–∏—Å–ª–∏—Ç—å –±–æ–Ω—É—Å
  const newBonusMonths = (referrer.bonus_months || 0) + 1;

  await supabase
    .from('profiles')
    .update({
      bonus_months: newBonusMonths,
      referrals_count: (referrer.referrals_count || 0) + 1,
    })
    .eq('id', referrer.id);

  // 5. –ó–∞–ø–∏—Å–∞—Ç—å –≤ –∏—Å—Ç–æ—Ä–∏—é
  await supabase
    .from('referral_bonuses')
    .insert({
      user_id: referrer.id,
      referred_user_id: newUserId,
      bonus_months: 1,
      granted_at: new Date().toISOString(),
    });

  // 6. –û—Ç–ø—Ä–∞–≤–∏—Ç—å email —Ä–µ—Ñ–µ—Ä–µ—Ä—É
  await sendReferralBonusEmail(referrer);
}
```

---

## –ó–∞—â–∏—Ç–∞ –æ—Ç —Ñ—Ä–æ–¥–∞

### –ü—Ä–æ–≤–µ—Ä–∫–∏ –ø—Ä–∏ –≤–∞–ª–∏–¥–∞—Ü–∏–∏ —Ä–µ—Ñ–µ—Ä–∞–ª—å–Ω–æ–≥–æ –∫–æ–¥–∞

**–§–∞–π–ª:** `frontend/app/api/referral/validate/route.ts`

```typescript
export async function POST(request: Request) {
  const { code, email } = await request.json();

  // 1. –ö–æ–¥ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç?
  const { data: referrer } = await supabase
    .from('profiles')
    .select('*')
    .eq('referral_code', code)
    .single();

  if (!referrer) {
    return NextResponse.json({
      valid: false,
      error: 'INVALID_CODE'
    });
  }

  // 2. –°–∞–º–æ—Ä–µ—Ñ–µ—Ä–∞–ª?
  if (referrer.email?.toLowerCase() === email.toLowerCase()) {
    return NextResponse.json({
      valid: false,
      error: 'SELF_REFERRAL'
    });
  }

  // 3. –†–µ—Ñ–µ—Ä–µ—Ä –∫—É–ø–∏–ª –∞–∫–∫–∞—É–Ω—Ç?
  if (!referrer.account_purchased) {
    return NextResponse.json({
      valid: false,
      error: 'REFERRER_NOT_ACTIVE'
    });
  }

  return NextResponse.json({
    valid: true,
    referrerName: referrer.name
  });
}
```

### –ü—Ä–æ–≤–µ—Ä–∫–∏ –ø—Ä–∏ –Ω–∞—á–∏—Å–ª–µ–Ω–∏–∏ –±–æ–Ω—É—Å–∞ (Webhook)

```typescript
function validateReferral(
  referrer: Profile,
  newUser: Profile,
  paymentAmount: number
): boolean {

  // 1. –†–µ–∞–ª—å–Ω—ã–π –ø–ª–∞—Ç—ë–∂ (–Ω–µ —Ç—Ä–∏–∞–ª, –Ω–µ $0)
  if (paymentAmount <= 0) {
    console.warn('Zero payment amount');
    return false;
  }

  // 2. –°–∞–º–æ—Ä–µ—Ñ–µ—Ä–∞–ª –ø–æ email
  if (referrer.email?.toLowerCase() === newUser.email?.toLowerCase()) {
    console.warn('Self-referral detected');
    return false;
  }

  // 3. –†–µ—Ñ–µ—Ä–µ—Ä –∏–º–µ–µ—Ç –ø–ª–∞—Ç–Ω—ã–π –∞–∫–∫–∞—É–Ω—Ç
  if (!referrer.account_purchased) {
    console.warn('Referrer has no paid account');
    return false;
  }

  // 4. –ü—Ä–æ–≤–µ—Ä–∫–∞ —á–∞—Å—Ç–æ—Ç—ã (>5 —Ä–µ—Ñ–µ—Ä–∞–ª–æ–≤ –∑–∞ 24 —á–∞—Å–∞ = –ø–æ–¥–æ–∑—Ä–∏—Ç–µ–ª—å–Ω–æ)
  const recentReferrals = await countRecentReferrals(referrer.id, 24);
  if (recentReferrals > 5) {
    console.warn('Suspicious referral frequency:', recentReferrals);
    // –õ–æ–≥–∏—Ä—É–µ–º, –Ω–æ –≤—Å—ë —Ä–∞–≤–Ω–æ –Ω–∞—á–∏—Å–ª—è–µ–º (—Ä—É—á–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞)
  }

  // 5. –ü—Ä–æ–≤–µ—Ä–∫–∞ –¥–æ–º–µ–Ω–∞ email (–æ–¥–∏–Ω–∞–∫–æ–≤—ã–π –¥–æ–º–µ–Ω = –ø–æ–¥–æ–∑—Ä–∏—Ç–µ–ª—å–Ω–æ)
  const referrerDomain = referrer.email?.split('@')[1];
  const newUserDomain = newUser.email?.split('@')[1];
  if (referrerDomain === newUserDomain) {
    console.warn('Same email domain:', referrerDomain);
    // –õ–æ–≥–∏—Ä—É–µ–º, –Ω–æ –Ω–∞—á–∏—Å–ª—è–µ–º (–º–æ–∂–µ—Ç –±—ã—Ç—å –∫–æ—Ä–ø–æ—Ä–∞—Ç–∏–≤–Ω—ã–π)
  }

  return true;
}

async function countRecentReferrals(userId: string, hours: number): Promise<number> {
  const since = new Date(Date.now() - hours * 60 * 60 * 1000);

  const { count } = await supabase
    .from('referral_bonuses')
    .select('*', { count: 'exact', head: true })
    .eq('user_id', userId)
    .gte('granted_at', since.toISOString());

  return count || 0;
}
```

### –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –ø–æ–¥–æ–∑—Ä–∏—Ç–µ–ª—å–Ω–æ–π –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏

```typescript
async function logSuspiciousReferral(data: {
  referrerId: string;
  newUserId: string;
  reason: string;
}) {
  await supabase
    .from('referral_fraud_logs')
    .insert({
      referrer_id: data.referrerId,
      referred_user_id: data.newUserId,
      reason: data.reason,
      created_at: new Date().toISOString(),
    });
}
```

---

## –¢–∞–±–ª–∏—Ü—ã –≤ Supabase

### –¢–∞–±–ª–∏—Ü–∞ `profiles` (—Ä–µ—Ñ–µ—Ä–∞–ª—å–Ω—ã–µ –ø–æ–ª—è)

```sql
-- –†–µ—Ñ–µ—Ä–∞–ª—å–Ω—ã–µ –ø–æ–ª—è –≤ profiles
referral_code VARCHAR(20) UNIQUE,    -- –£–Ω–∏–∫–∞–ª—å–Ω—ã–π –∫–æ–¥ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è (NAT1001)
referred_by VARCHAR(20),             -- –ö–æ–¥ —Ç–æ–≥–æ, –∫—Ç–æ –ø—Ä–∏–≥–ª–∞—Å–∏–ª
bonus_months INTEGER DEFAULT 0,      -- –ù–∞–∫–æ–ø–ª–µ–Ω–Ω—ã–µ –±–æ–Ω—É—Å–Ω—ã–µ –º–µ—Å—è—Ü—ã
referrals_count INTEGER DEFAULT 0,   -- –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –ø—Ä–∏–≥–ª–∞—à—ë–Ω–Ω—ã—Ö (—Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞)
account_purchased BOOLEAN,           -- –ö—É–ø–ª–µ–Ω –ª–∏ –∞–∫–∫–∞—É–Ω—Ç (–¥–ª—è –≤–∞–ª–∏–¥–∞—Ü–∏–∏)
```

### –¢–∞–±–ª–∏—Ü–∞ `referral_bonuses`

```sql
CREATE TABLE referral_bonuses (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  user_id UUID NOT NULL REFERENCES profiles(id),         -- –†–µ—Ñ–µ—Ä–µ—Ä
  referred_user_id UUID NOT NULL REFERENCES profiles(id), -- –ü—Ä–∏–≥–ª–∞—à—ë–Ω–Ω—ã–π
  bonus_months INTEGER DEFAULT 1,                         -- –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –º–µ—Å—è—Ü–µ–≤
  granted_at TIMESTAMPTZ DEFAULT NOW(),                   -- –ö–æ–≥–¥–∞ –Ω–∞—á–∏—Å–ª–µ–Ω

  UNIQUE(user_id, referred_user_id)  -- –û–¥–∏–Ω –±–æ–Ω—É—Å –∑–∞ –æ–¥–Ω–æ–≥–æ –ø—Ä–∏–≥–ª–∞—à—ë–Ω–Ω–æ–≥–æ
);

-- –ò–Ω–¥–µ–∫—Å—ã
CREATE INDEX idx_referral_bonuses_user ON referral_bonuses(user_id);
CREATE INDEX idx_referral_bonuses_granted ON referral_bonuses(granted_at);
```

### –¢–∞–±–ª–∏—Ü–∞ `referral_fraud_logs` (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)

```sql
CREATE TABLE referral_fraud_logs (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  referrer_id UUID REFERENCES profiles(id),
  referred_user_id UUID REFERENCES profiles(id),
  reason VARCHAR(100),
  created_at TIMESTAMPTZ DEFAULT NOW()
);
```

---

## –ü—Ä–∏–º–µ—Ä—ã –∫–æ–¥–∞

### –°—Ç—Ä–∞–Ω–∏—Ü–∞ —Ä–µ—Ñ–µ—Ä–∞–ª—å–Ω–æ–π –ø—Ä–æ–≥—Ä–∞–º–º—ã

**–§–∞–π–ª:** `frontend/app/[locale]/dashboard/referral/page.tsx`

```typescript
"use client";

import { useState, useEffect } from "react";
import { createClient } from "@/lib/supabase/client";
import { getUserTier, canUseFeature } from "@/lib/subscription";

export default function ReferralPage() {
  const [profile, setProfile] = useState<any>(null);
  const [referrals, setReferrals] = useState<any[]>([]);
  const [copied, setCopied] = useState(false);

  useEffect(() => {
    loadData();
  }, []);

  const loadData = async () => {
    const supabase = createClient();
    const { data: { user } } = await supabase.auth.getUser();

    // –ó–∞–≥—Ä—É–∑–∏—Ç—å –ø—Ä–æ—Ñ–∏–ª—å
    const { data: profileData } = await supabase
      .from('profiles')
      .select('*')
      .eq('id', user?.id)
      .single();

    setProfile(profileData);

    // –ó–∞–≥—Ä—É–∑–∏—Ç—å –ø—Ä–∏–≥–ª–∞—à—ë–Ω–Ω—ã—Ö
    const { data: referralsData } = await supabase
      .from('profiles')
      .select('id, name, email, account_purchased, created_at')
      .eq('referred_by', profileData?.referral_code);

    setReferrals(referralsData || []);
  };

  const tier = getUserTier(profile);
  const hasAccess = canUseFeature(tier, 'referralProgram');

  if (!hasAccess) {
    return (
      <div className="restriction-message">
        <h2>–†–µ—Ñ–µ—Ä–∞–ª—å–Ω–∞—è –ø—Ä–æ–≥—Ä–∞–º–º–∞</h2>
        <p>–î–æ—Å—Ç—É–ø–Ω–∞ —Ç–æ–ª—å–∫–æ –ø–æ—Å–ª–µ –ø–æ–∫—É–ø–∫–∏ –∞–∫–∫–∞—É–Ω—Ç–∞</p>
        <a href="/pricing">–ö—É–ø–∏—Ç—å –∞–∫–∫–∞—É–Ω—Ç</a>
      </div>
    );
  }

  const referralLink = `https://apallaktis.com/el/register?ref=${profile?.referral_code}`;

  const copyLink = () => {
    navigator.clipboard.writeText(referralLink);
    setCopied(true);
    setTimeout(() => setCopied(false), 2000);
  };

  const shareViber = () => {
    window.open(`viber://forward?text=${encodeURIComponent(referralLink)}`);
  };

  const shareWhatsApp = () => {
    window.open(`https://wa.me/?text=${encodeURIComponent(referralLink)}`);
  };

  const shareEmail = () => {
    window.open(`mailto:?subject=APALLAKTIS&body=${encodeURIComponent(referralLink)}`);
  };

  // –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞
  const totalReferrals = referrals.length;
  const purchasedCount = referrals.filter(r => r.account_purchased).length;
  const totalBonusMonths = profile?.bonus_months || 0;

  return (
    <div className="referral-page">
      <h1>–†–µ—Ñ–µ—Ä–∞–ª—å–Ω–∞—è –ø—Ä–æ–≥—Ä–∞–º–º–∞</h1>

      {/* –†–µ—Ñ–µ—Ä–∞–ª—å–Ω–∞—è —Å—Å—ã–ª–∫–∞ */}
      <div className="referral-link-box">
        <label>–í–∞—à–∞ —Ä–µ—Ñ–µ—Ä–∞–ª—å–Ω–∞—è —Å—Å—ã–ª–∫–∞:</label>
        <div className="link-input">
          <input type="text" value={referralLink} readOnly />
          <button onClick={copyLink}>
            {copied ? '‚úì –°–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–æ' : '–ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å'}
          </button>
        </div>
      </div>

      {/* –ö–Ω–æ–ø–∫–∏ —à–∞—Ä–∏–Ω–≥–∞ */}
      <div className="share-buttons">
        <button onClick={shareViber} className="viber">
          Viber
        </button>
        <button onClick={shareWhatsApp} className="whatsapp">
          WhatsApp
        </button>
        <button onClick={shareEmail} className="email">
          Email
        </button>
      </div>

      {/* –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ */}
      <div className="stats-grid">
        <div className="stat-card">
          <div className="value">{totalReferrals}</div>
          <div className="label">–í—Å–µ–≥–æ –ø—Ä–∏–≥–ª–∞—à–µ–Ω–æ</div>
        </div>
        <div className="stat-card">
          <div className="value">{purchasedCount}</div>
          <div className="label">–ö—É–ø–∏–ª–∏ –∞–∫–∫–∞—É–Ω—Ç</div>
        </div>
        <div className="stat-card">
          <div className="value">{purchasedCount}</div>
          <div className="label">–í—Å–µ–≥–æ –±–æ–Ω—É—Å–æ–≤</div>
        </div>
        <div className="stat-card highlight">
          <div className="value">{totalBonusMonths}</div>
          <div className="label">–î–æ—Å—Ç—É–ø–Ω–æ –º–µ—Å—è—Ü–µ–≤</div>
        </div>
      </div>

      {/* –°–ø–∏—Å–æ–∫ –ø—Ä–∏–≥–ª–∞—à—ë–Ω–Ω—ã—Ö */}
      <h2>–ü—Ä–∏–≥–ª–∞—à—ë–Ω–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏</h2>
      <table>
        <thead>
          <tr>
            <th>–ò–º—è</th>
            <th>–î–∞—Ç–∞ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏</th>
            <th>–°—Ç–∞—Ç—É—Å</th>
          </tr>
        </thead>
        <tbody>
          {referrals.map(r => (
            <tr key={r.id}>
              <td>{r.name}</td>
              <td>{new Date(r.created_at).toLocaleDateString()}</td>
              <td>
                {r.account_purchased ? (
                  <span className="badge success">–ö—É–ø–∏–ª</span>
                ) : (
                  <span className="badge pending">–ó–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω</span>
                )}
              </td>
            </tr>
          ))}
        </tbody>
      </table>
    </div>
  );
}
```

### –í–∞–ª–∏–¥–∞—Ü–∏—è –∫–æ–¥–∞ –ø—Ä–∏ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏

```typescript
// –í register/page.tsx

const [referralCode, setReferralCode] = useState('');
const [referralValid, setReferralValid] = useState<boolean | null>(null);
const [referralError, setReferralError] = useState('');

// –ü–æ–ª—É—á–∏—Ç—å –∫–æ–¥ –∏–∑ URL
useEffect(() => {
  const urlParams = new URLSearchParams(window.location.search);
  const ref = urlParams.get('ref');
  if (ref) {
    setReferralCode(ref);
  }
}, []);

// –í–∞–ª–∏–¥–∞—Ü–∏—è –ø—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏ email
useEffect(() => {
  if (referralCode && formData.email) {
    validateReferralCode();
  }
}, [referralCode, formData.email]);

const validateReferralCode = async () => {
  const response = await fetch('/api/referral/validate', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({
      code: referralCode,
      email: formData.email,
    }),
  });

  const data = await response.json();

  if (data.valid) {
    setReferralValid(true);
    setReferralError('');
  } else {
    setReferralValid(false);
    switch (data.error) {
      case 'INVALID_CODE':
        setReferralError('–†–µ—Ñ–µ—Ä–∞–ª—å–Ω—ã–π –∫–æ–¥ –Ω–µ –Ω–∞–π–¥–µ–Ω');
        break;
      case 'SELF_REFERRAL':
        setReferralError('–ù–µ–ª—å–∑—è –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å —Å–≤–æ–π –∫–æ–¥');
        break;
      case 'REFERRER_NOT_ACTIVE':
        setReferralError('–†–µ—Ñ–µ—Ä–µ—Ä –Ω–µ –∏–º–µ–µ—Ç –∞–∫—Ç–∏–≤–Ω–æ–≥–æ –∞–∫–∫–∞—É–Ω—Ç–∞');
        break;
    }
  }
};
```

### Email —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è

```typescript
// lib/email/notifications.ts

export async function sendNewReferralEmail(referrer: Profile) {
  await resend.emails.send({
    from: 'APALLAKTIS <noreply@apallaktis.com>',
    to: referrer.email,
    subject: 'üéâ –ù–æ–≤—ã–π —Ä–µ—Ñ–µ—Ä–∞–ª!',
    html: `
      <h1>–ü—Ä–∏–≤–µ—Ç, ${referrer.name}!</h1>
      <p>–ö—Ç–æ-—Ç–æ –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–ª—Å—è –ø–æ –≤–∞—à–µ–π —Ä–µ—Ñ–µ—Ä–∞–ª—å–Ω–æ–π —Å—Å—ã–ª–∫–µ!</p>
      <p>–ö–æ–≥–¥–∞ –æ–Ω–∏ –∫—É–ø—è—Ç –∞–∫–∫–∞—É–Ω—Ç, –≤—ã –ø–æ–ª—É—á–∏—Ç–µ +1 –±–µ—Å–ø–ª–∞—Ç–Ω—ã–π –º–µ—Å—è—Ü.</p>
    `,
  });
}

export async function sendReferralBonusEmail(referrer: Profile) {
  await resend.emails.send({
    from: 'APALLAKTIS <noreply@apallaktis.com>',
    to: referrer.email,
    subject: 'üéÅ –í—ã –ø–æ–ª—É—á–∏–ª–∏ –±–æ–Ω—É—Å–Ω—ã–π –º–µ—Å—è—Ü!',
    html: `
      <h1>–ü–æ–∑–¥—Ä–∞–≤–ª—è–µ–º, ${referrer.name}!</h1>
      <p>–í–∞—à –ø—Ä–∏–≥–ª–∞—à—ë–Ω–Ω—ã–π –∫—É–ø–∏–ª –∞–∫–∫–∞—É–Ω—Ç!</p>
      <p>–í–∞–º –Ω–∞—á–∏—Å–ª–µ–Ω <strong>+1 –±–µ—Å–ø–ª–∞—Ç–Ω—ã–π –º–µ—Å—è—Ü</strong>.</p>
      <p>–¢–µ–∫—É—â–∏–π –±–∞–ª–∞–Ω—Å: <strong>${referrer.bonus_months + 1} –º–µ—Å—è—Ü–µ–≤</strong></p>
    `,
  });
}
```

---

## –°—Ç—Ä—É–∫—Ç—É—Ä–∞ —Ñ–∞–π–ª–æ–≤

```
frontend/
‚îú‚îÄ‚îÄ app/
‚îÇ   ‚îú‚îÄ‚îÄ [locale]/
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ dashboard/
‚îÇ   ‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ referral/page.tsx    # –°—Ç—Ä–∞–Ω–∏—Ü–∞ —Ä–µ—Ñ–µ—Ä–∞–ª—å–Ω–æ–π –ø—Ä–æ–≥—Ä–∞–º–º—ã
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ register/page.tsx        # –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è —Å —Ä–µ—Ñ–µ—Ä–∞–ª—å–Ω—ã–º –∫–æ–¥–æ–º
‚îÇ   ‚îî‚îÄ‚îÄ api/
‚îÇ       ‚îú‚îÄ‚îÄ referral/
‚îÇ       ‚îÇ   ‚îî‚îÄ‚îÄ validate/route.ts    # –í–∞–ª–∏–¥–∞—Ü–∏—è –∫–æ–¥–∞
‚îÇ       ‚îî‚îÄ‚îÄ stripe/
‚îÇ           ‚îî‚îÄ‚îÄ webhook/route.ts     # –ù–∞—á–∏—Å–ª–µ–Ω–∏–µ –±–æ–Ω—É—Å–æ–≤
‚îú‚îÄ‚îÄ lib/
‚îÇ   ‚îú‚îÄ‚îÄ subscription.ts              # –ü—Ä–æ–≤–µ—Ä–∫–∞ –¥–æ—Å—Ç—É–ø–∞ –∫ –ø—Ä–æ–≥—Ä–∞–º–º–µ
‚îÇ   ‚îî‚îÄ‚îÄ email/
‚îÇ       ‚îî‚îÄ‚îÄ notifications.ts         # Email —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è
‚îÇ
database/
‚îú‚îÄ‚îÄ schema.sql                       # –¢–∞–±–ª–∏—Ü–∞ referral_bonuses
‚îî‚îÄ‚îÄ migrations/
    ‚îî‚îÄ‚îÄ ensure_referral_columns.sql  # –†–µ—Ñ–µ—Ä–∞–ª—å–Ω—ã–µ –ø–æ–ª—è –≤ profiles
```

---

*–î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è —Å–æ–∑–¥–∞–Ω–∞: 2025-01-25*
