1. Система оплаты (2 этапа)

ЭТАП 1: Покупка аккаунта (единоразовый платеж)

2 Правильная логика оплаты (ВАЖНО!)

Этап 1: DEMO период (48 часов)

Новый пользователь получает 48 часов бесплатного доступа для знакомства с платформой. В DEMO версии доступен полный функционал, но есть ограничение - максимум 3 проекта. После окончания DEMO периода пользователь должен купить полный аккаунт 

Этап 2: Первый месяц БЕСПЛАТНО

После покупки аккаунта клиент получает 1 месяц бесплатного использования. В этот период доступны все функции платформы и неограниченное количество проектов. Подписка на этом этапе не требуется - первый месяц включен в стоимость аккаунта.

Этап 3: Выбор подписки (за 2 дня до окончания бесплатного периода)

ВАЖНО: Дата оплаты подписки = дата покупки аккаунта каждый месяц.

Примеры:
- Если клиент купил аккаунт 15 ноября, то первая оплата подписки будет 15 декабря
- Если клиент купил аккаунт 3 декабря, то первая оплата подписки будет 3 января
- Если клиент купил аккаунт 28 января, то первая оплата подписки будет 28 февраля

За 2 дня до окончания бесплатного месяца система анализирует активность пользователя. На основе этого анализа система автоматически предлагает оптимальную подписку. Клиент должен выбрать тариф до своей даты оплаты. Если клиент не выбрал подписку, аккаунт переходит в режим "только чтение".

4. Умная система предложения подписки (на 28-й день)

Анализ активности клиента:

Система анализирует следующие показатели:
- Количество проектов (открытых и закрытых)
- Количество записей (доходы и расходы)
- Частота использования (количество входов в систему)
- Использование OCR (фотографирование чеков)
- Использование голосового ввода

На основе этих данных система предлагает оптимальный тариф для каждого клиента.

Примеры рекомендаций:

Сценарий 1: Легкое использование

Клиент создал 3 проекта и 45 записей. Заходил в систему 8 раз за месяц.

Рекомендация системы:

Ваша статистика за месяц:
- Проектов: 3
- Записей: 45

Рекомендуем тариф: БАЗОВЫЙ
До 10 проектов
- Все функции платформы

Этого тарифа вам более чем достаточно для текущей активности!

Кнопки: "Выбрать Базовый" и "Посмотреть другие тарифы"

Сценарий 2: Среднее использование

Клиент создал 12 проектов и 287 записей. Заходил в систему 24 раза за месяц. Использовал OCR (фотографирование чеков) 15 раз.

Рекомендация системы:

Ваша статистика за месяц:
- Проектов: 12
- Записей: 287
- Фото чеков: 15

Рекомендуем тариф: СТАНДАРТ 
- До 50 проектов
- Приоритетная поддержка
- Расширенная аналитика

Вы активный пользователь! Стандарт даст вам больше возможностей для роста.

Кнопки: "Выбрать Стандарт" (рекомендуется) и "Посмотреть другие тарифы"

Сценарий 3: Активное использование

Клиент создал 35 проектов и 892 записи. Заходил в систему 45 раз за месяц. Использовал OCR 87 раз, голосовой ввод 45 раз. Добавил 2 членов команды (пробовал функцию).

Рекомендация системы:

Ваша статистика за месяц:
- Проектов: 35 (очень активно!)
- Записей: 892
- Фото чеков: 87
- Голосовой ввод: 45

Рекомендуем тариф: ПРЕМИУМ 
- Неограниченные проекты
- Команда до 3 человек
- VIP поддержка 24/7
- Все продвинутые функции

Вы профессионал! Премиум создан специально для таких как вы.

Кнопки: "Выбрать Премиум" (рекомендуется) и "Посмотреть другие тарифы"

5. График уведомлений

День 1 (начало DEMO):

Email: "Добро пожаловать в Απαλλάκτης ! У вас 48 часов бесплатного DEMO"

День 2 (DEMO):

SMS: "Завтра заканчивается DEMO"
Email: "Последний день DEMO! Купите аккаунт и получите первый месяц бесплатно"

Кнопки в письме: 
- "Купить аккаунт"
- "Связаться с администратором через WhatsApp" – активна +30 69 83 20 88 44
- "Связаться с администратором через Viber" – активна +30 69 83 20 88 44

День 3 (конец DEMO):

Блокировка доступа к аккаунту.
Экран блокировки:
DEMO период истек
Для продолжения работы приобретите полный аккаунт 
Первый месяц подписка - бесплатно!

При нажатии на кнопку WhatsApp или Viber открывается приложение с готовым сообщением: "Здравствуйте! Хочу купить аккаунт ΑΠΑΛΛΑΚΤΗΣ . Мой DEMO истек. Мой номер в системе: #____"
1010 – это первый порядковый номер
День 1 (после покупки аккаунта):
Email: "Спасибо за покупку! Ваш аккаунт #1010 активирован. 30 дней бесплатного использования начались!"

SMS: "Сегодня последний день! Выберите подписку"
Push-уведомление в приложении
Экран выбора подписки (нельзя закрыть без выбора)

(если не выбрал подписку):

Режим "только чтение"
Клиент может:
- Просматривать проекты

Клиент НЕ может:
- Экспортировать данные
- Добавлять или редактировать записи
- Создавать новые проекты


2. ТЗ: Автозаполнение карточки клиента по ΑΦΜ (Greece)
1) Цель

Реализовать функциональность: пользователь вводит ΑΦΜ клиента → система проверяет валидность и, где возможно, подтягивает и заполняет данные клиента в карточке (Client Profile). Функциональность должна работать для:

юридических лиц (компании)

физических лиц (минимальный набор; без “поиска персональных данных”)

2) Юридические и продуктовые ограничения (обязательно)

Система не должна “искать всё подряд” по ΑΦΜ в обход авторизации/капчи/личных кабинетов.

Разрешены источники:

VIES (проверка VAT/ΦΠΑ статуса) — публичный EU сервис.

ΓΕΜΗ (бизнес-реестр) — публичные/официальные данные о компаниях (в рамках доступности).

ΑΑΔΕ — только через официальные/сертифицированные каналы или провайдеров (если подключим на Phase 2).

GDPR:

сохранять только данные, необходимые для договора/выставления документов (data minimization).

фиксировать основание обработки: “ввод пользователем” + “договор/счёт”.

иметь возможность удалить/анонимизировать клиента по запросу.

3) Объём данных (что заполняем)
3.1 Минимум (MVP, Phase 1)

Общее:

afm (строго 9 цифр)

country = GR

entity_type = company | individual | unknown

verification_status = verified | partially_verified | failed

source_flags = { vies, gemi }

Если компания:

legal_name (επωνυμία)

trade_name (если доступно)

legal_form (IKE, AE, OE, EPE и т.п., если доступно)

doy (если доступно)

address (если доступно: street, city, postal_code)

status (active / inactive / unknown)

Если физ. лицо:

только afm + entity_type=individual + verification_status (без попыток вытащить ФИО из госбаз без легального канала).

3.2 Расширение (Phase 2, через провайдера ΑΑΔΕ)

подтверждение статуса ΑΦΜ (активен/нет)

ΔΟΥ

официальное имя/название (как в ΑΑΔΕ)

дополнительные атрибуты, если провайдер отдаёт их легально

4) UX/UI требования
4.1 Поля на форме “Клиент”

ΑΦΜ (input, маска 9 цифр)

Кнопка: «Найти по ΑΦΜ»

Индикатор статуса: “Проверено / Частично / Не найдено / Ошибка”

Секция “Источник данных”: VIES / ΓΕΜΗ / (AADE позже), дата обновления

4.2 Логика поведения

Пользователь вводит ΑΦΜ → фронт делает базовую валидацию:

9 цифр

(опционально) контрольная сумма ΑΦΜ (алгоритм мод 11)

Нажимает “Найти по ΑΦΜ”:

показываем loading

блокируем повторные клики (debounce 2–3 сек)

При успехе:

автозаполняем поля

показываем “обновлено: дата/время”

При частичном успехе:

заполняем то, что нашли

показываем “частично: VIES ok, ΓΕΜΗ недоступно”

При ошибке:

показываем понятное сообщение

пишем детали в серверный лог

5) Архитектура (строго)

Claude Code должен реализовать через backend-слой. Фронт не должен ходить к внешним реестрам напрямую.

Компоненты:

Frontend (Next.js/React)

Backend API (Node/Express или Next API routes)

Integrations layer:

viesClient

gemiClient

(позже) aadeProviderClient

DB (PostgreSQL)

Логи (structured logging)

6) API контракты (backend)
6.1 Endpoint: поиск по ΑΦΜ

POST /api/clients/lookup-afm

Request

{
  "afm": "123456789",
  "forceRefresh": false
}


Response (успех)

{
  "afm": "123456789",
  "entityType": "company",
  "verificationStatus": "verified",
  "sources": {
    "vies": { "status": "ok", "checkedAt": "2025-12-25T14:10:00Z" },
    "gemi": { "status": "ok", "checkedAt": "2025-12-25T14:10:02Z" }
  },
  "data": {
    "legalName": "COMPANY SA",
    "tradeName": "COMPANY",
    "legalForm": "AE",
    "doy": "ΔΟΥ ΝΙΚΑΙΑΣ",
    "address": {
      "street": "…",
      "city": "Αθήνα",
      "postalCode": "…"
    },
    "status": "active"
  }
}


Response (частично)

{
  "afm": "123456789",
  "entityType": "company",
  "verificationStatus": "partially_verified",
  "sources": {
    "vies": { "status": "ok" },
    "gemi": { "status": "failed", "errorCode": "GEMI_TIMEOUT" }
  },
  "data": {
    "legalName": "COMPANY SA"
  }
}


Ошибки

400 INVALID_AFM_FORMAT

404 NOT_FOUND (если ни один источник не дал данных)

429 RATE_LIMIT

502 UPSTREAM_ERROR

6.2 Endpoint: сохранение клиента

POST /api/clients

принимает поля из формы + lookupMetadata (кто/когда подтянул, источники)

7) База данных (PostgreSQL)
7.1 Таблица clients

id UUID PK

afm varchar(9) unique index

entity_type enum

legal_name text

trade_name text

legal_form text

doy text

address_json jsonb

status text

created_at, updated_at

7.2 Таблица client_lookups (аудит и отладка)

id UUID PK

client_id UUID FK nullable

afm varchar(9)

requested_by_user_id UUID

sources_json jsonb (статусы, времена, ошибки)

result_hash text (для кэширования)

created_at

8) Кэширование и лимиты

Кэшировать результаты lookup по afm на 24 часа (configurable).

forceRefresh=true — разрешать только админам/ролям.

Rate-limit на endpoint: например 30 запросов/мин на пользователя.

9) Интеграции: требования к модулям
9.1 viesClient

функция checkVat(afm, country='GR')

возвращает: isValid, name, address (если доступно)

обрабатывает:

timeout (например 5–8 сек)

retry 1 раз (только на сетевые ошибки)

9.2 gemiClient

функция lookupCompanyByAfm(afm)

возвращает: legalName, legalForm, address, status (если доступно)

иметь адаптер, чтобы легко заменить реализацию (если сменится API/источник)

9.3 aadeProviderClient (Phase 2)

подключение по API key/OAuth (как даст провайдер)

строго хранить ключи в env/secrets

логировать только коды ошибок, не секреты

10) Обработка качества данных (нормализация)

trim, uppercase для названий (по необходимости)

адрес хранить “как пришёл” + опционально отдельные поля

если VIES дал имя, а ΓΕΜΗ другое:

приоритет: ΓΕΜΗ для company profile (если источник надёжнее по доступности)

сохранить оба в sources_json

11) Безопасность

Никаких секретов во фронтенде.

Логи: не писать полные ответы внешних сервисов, только нужные поля.

Защитить endpoint авторизацией (только залогиненные).

12) Тест-кейсы (минимум)

ΑΦΜ меньше/больше 9 цифр → 400

ΑΦΜ с буквами → 400

Валидный ΑΦΜ, VIES ok, ΓΕΜΗ ok → verified

VIES ok, ΓΕΜΗ timeout → partially_verified

Оба источника недоступны → 502/404 (по логике)

Повторный запрос в течение 24ч → ответ из cache

forceRefresh без прав → 403

Rate limit превышен → 429

13) Definition of Done (критерии готовности)

UI: кнопка “Найти по ΑΦΜ”, статус, автозаполнение

Backend: endpoint lookup-afm + кэш + rate-limit + логирование

DB: таблицы clients + client_lookups

Покрытие тест-кейсами (unit + integration)

Документация: README “как настроить ключи/провайдеры”


3. нужно провести чистку на ненужные файлы и если не используем, их удалить 
