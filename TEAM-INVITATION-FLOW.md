# Team Invitation Flow / Процесс приглашения в команду

## Обзор

Система позволяет владельцу подписки приглашать коллег для совместного управления объектами недвижимости. Приглашённые получают доступ ко всем данным команды без необходимости оплаты собственной подписки.

---

## СЦЕНАРИЙ: Владелец аккаунта приглашает коллегу

### ШАГ 1: Владелец аккаунта отправляет приглашение

#### Где найти кнопку "Пригласить"?

1. Войдите в личный кабинет (Dashboard)
2. В боковом меню выберите **"Команда"** / **"Team"**
3. URL: `/{locale}/dashboard/team`

#### Интерфейс страницы команды

```
┌─────────────────────────────────────────────────────────────┐
│  Моя команда                                                │
│  ───────────────────────────────────────────────────────── │
│                                                             │
│  Участники (1/2)                     [+ Пригласить]         │
│  ─────────────────                                          │
│  ┌─────────────────────────────────────────────────────┐   │
│  │ 👤 Ivan Petrov         Владелец    Присоединился    │   │
│  │    ivan@example.com               15 янв 2025       │   │
│  └─────────────────────────────────────────────────────┘   │
│                                                             │
│  Ожидающие приглашения                                     │
│  ─────────────────────                                      │
│  (пусто)                                                    │
│                                                             │
└─────────────────────────────────────────────────────────────┘
```

#### Что нужно ввести?

При нажатии кнопки **"Пригласить"** открывается модальное окно:

```
┌─────────────────────────────────────────┐
│  Пригласить в команду                   │
│  ─────────────────────────────────────  │
│                                         │
│  Email коллеги:                         │
│  ┌─────────────────────────────────┐   │
│  │ colleague@example.com           │   │
│  └─────────────────────────────────┘   │
│                                         │
│  [Отмена]              [Отправить]      │
└─────────────────────────────────────────┘
```

#### Что происходит после нажатия "Отправить"?

1. **Проверка лимитов**: Система проверяет, позволяет ли подписка добавить ещё участника
2. **Проверка дубликатов**: Нельзя пригласить уже существующего участника или повторно отправить pending-приглашение
3. **Генерация токена**: Создаётся уникальный 64-символьный токен
4. **Запись в БД**: Приглашение сохраняется в `team_invitations` со сроком действия 7 дней
5. **Отправка email**: На указанный адрес отправляется письмо с приглашением

**Лимиты по подпискам:**
| План | Максимум участников |
|------|---------------------|
| Demo | 1 (только владелец) |
| Basic | 1 (только владелец) |
| Standard | 2 (владелец + 1) |
| Premium | Без ограничений |
| VIP | Без ограничений |

---

### ШАГ 2: Приглашённый получает email

#### Как выглядит письмо?

**Тема письма:**
```
🤝 Πрόσκληση στην ομάδα "Название команды" - АПАЛЛАКТИС
```
(адаптируется под язык системы: греческий, русский, английский, украинский, албанский, болгарский, румынский, арабский)

**Содержимое письма:**

```
┌─────────────────────────────────────────────────────────────┐
│                         АПАЛЛАКТИС                          │
│                                                             │
│  Здравствуйте!                                              │
│                                                             │
│  Ivan Petrov приглашает вас присоединиться к команде       │
│  "Команда Петрова" в АПАЛЛАКТИС.                           │
│                                                             │
│  Присоединившись к команде, вы получите доступ к:          │
│  • Управлению объектами недвижимости                       │
│  • Отслеживанию счетов и платежей                          │
│  • Общим данным команды                                    │
│                                                             │
│            ┌────────────────────────────┐                   │
│            │   Принять приглашение      │                   │
│            └────────────────────────────┘                   │
│                                                             │
│  Срок действия приглашения: 22 января 2025                 │
│                                                             │
│  Если вы не ожидали это письмо, просто проигнорируйте его. │
│                                                             │
│  ─────────────────────────────────────────────────────────  │
│  © 2025 АПАЛЛАКТИС                                          │
└─────────────────────────────────────────────────────────────┘
```

#### Какая ссылка в письме?

```
https://apallaktis.gr/{locale}/team-invite?token=abc123xyz...
```

- `{locale}` — язык приглашающего (el, ru, en, uk, sq, bg, ro, ar)
- `token` — уникальный 64-символьный токен приглашения

---

### ШАГ 3: Приглашённый переходит по ссылке

#### Сценарий A: Пользователь НЕ авторизован

```
┌─────────────────────────────────────────────────────────────┐
│  Приглашение в команду                                      │
│  ─────────────────────────────────────────────────────────  │
│                                                             │
│  Для принятия приглашения необходимо войти в систему       │
│                                                             │
│  ┌─────────────────────────────────────────────────────┐   │
│  │               [Войти в аккаунт]                     │   │
│  └─────────────────────────────────────────────────────┘   │
│                                                             │
│  ┌─────────────────────────────────────────────────────┐   │
│  │               [Зарегистрироваться]                  │   │
│  └─────────────────────────────────────────────────────┘   │
│                                                             │
└─────────────────────────────────────────────────────────────┘
```

**Важно:** После входа/регистрации пользователь автоматически возвращается на страницу приглашения.

#### Сценарий B: Пользователь авторизован

```
┌─────────────────────────────────────────────────────────────┐
│  Приглашение в команду                                      │
│  ─────────────────────────────────────────────────────────  │
│                                                             │
│  Ivan Petrov приглашает вас в команду:                     │
│                                                             │
│  ┌─────────────────────────────────────────────────────┐   │
│  │  🏢 Команда Петрова                                 │   │
│  │     План: Standard                                   │   │
│  │     Приглашение от: ivan@example.com                │   │
│  │     Действительно до: 22 января 2025                │   │
│  └─────────────────────────────────────────────────────┘   │
│                                                             │
│            ┌────────────────────────────┐                   │
│            │   Принять приглашение      │                   │
│            └────────────────────────────┘                   │
│                                                             │
└─────────────────────────────────────────────────────────────┘
```

#### Нужно ли регистрироваться?

**Да**, но только один раз:
- Если у пользователя нет аккаунта — нужно зарегистрироваться
- Регистрация бесплатна
- Email при регистрации **должен совпадать** с email в приглашении

#### Нужно ли покупать подписку?

**Нет!** Это главное преимущество системы:
- Приглашённый пользуется подпиской владельца команды
- Он получает полный доступ без оплаты
- Лимиты подписки контролирует владелец

#### Что происходит при нажатии "Принять"?

1. Проверяется совпадение email
2. Проверяется срок действия приглашения
3. Если пользователь был в другой команде (как участник) — он выходит из неё
4. Пользователь добавляется в команду с ролью `member`
5. Статус приглашения меняется на `accepted`
6. Показывается сообщение об успехе и ссылка на Dashboard

#### Ошибки, которые могут возникнуть:

| Ошибка | Причина |
|--------|---------|
| "Email не совпадает" | Вы вошли под другим email, чем указано в приглашении |
| "Приглашение истекло" | Прошло более 7 дней с момента отправки |
| "Приглашение недействительно" | Было отменено владельцем |
| "Вы уже являетесь владельцем команды" | Нельзя присоединиться, если вы владелец другой команды |

---

### ШАГ 4: Доступ к данным

#### Что видит приглашённый после входа?

После принятия приглашения пользователь видит **Dashboard с данными команды**:

```
┌─────────────────────────────────────────────────────────────┐
│  АПАЛЛАКТИС                                                 │
│  ─────────────────────────────────────────────────────────  │
│                                                             │
│  📊 Сводка                                                  │
│  ─────────────                                              │
│  Объекты: 5    Счета: 23    Ожидают: 3                     │
│                                                             │
│  🏠 Объекты команды                                         │
│  ─────────────────                                          │
│  • ул. Афин 15, кв. 3                                      │
│  • ул. Эрму 42                                             │
│  • пр. Синтагма 7, оф. 201                                 │
│  ...                                                        │
│                                                             │
└─────────────────────────────────────────────────────────────┘
```

#### Видит ли приглашённый все объекты владельца?

**Да!** Участник команды видит:
- ✅ Все объекты недвижимости команды
- ✅ Все счета и платежи
- ✅ Историю операций
- ✅ Документы и чеки

#### Может ли редактировать?

**Да**, участник команды может:
- ✅ Добавлять новые объекты
- ✅ Редактировать существующие объекты
- ✅ Добавлять счета и платежи
- ✅ Удалять данные (soft delete → корзина)

#### Какие ограничения у участника?

| Действие | Владелец | Участник |
|----------|----------|----------|
| Просмотр всех данных | ✅ | ✅ |
| Добавление/редактирование | ✅ | ✅ |
| Удаление (в корзину) | ✅ | ✅ |
| Приглашение новых участников | ✅ | ❌ |
| Удаление участников | ✅ | ❌ |
| Отмена приглашений | ✅ | ❌ |
| Управление подпиской | ✅ | ❌ |
| Выход из команды | ❌ | ✅ |

---

## ТЕХНИЧЕСКИЕ ДЕТАЛИ

### Таблицы базы данных

#### 1. `teams` — Команды

```sql
CREATE TABLE teams (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    name TEXT NOT NULL,
    owner_id UUID NOT NULL REFERENCES auth.users(id),
    subscription_plan TEXT DEFAULT 'basic',
    max_members INTEGER DEFAULT 1,
    created_at TIMESTAMPTZ DEFAULT NOW(),
    updated_at TIMESTAMPTZ DEFAULT NOW(),
    UNIQUE(owner_id)  -- один пользователь = одна команда как владелец
);
```

#### 2. `team_members` — Участники команды

```sql
CREATE TABLE team_members (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    team_id UUID NOT NULL REFERENCES teams(id) ON DELETE CASCADE,
    user_id UUID NOT NULL REFERENCES auth.users(id) ON DELETE CASCADE,
    role TEXT NOT NULL CHECK (role IN ('owner', 'member')),
    invited_at TIMESTAMPTZ DEFAULT NOW(),
    joined_at TIMESTAMPTZ DEFAULT NOW(),
    invited_by UUID REFERENCES auth.users(id),
    UNIQUE(team_id, user_id)
);
```

#### 3. `team_invitations` — Приглашения

```sql
CREATE TABLE team_invitations (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    team_id UUID NOT NULL REFERENCES teams(id) ON DELETE CASCADE,
    email TEXT NOT NULL,
    invited_by UUID NOT NULL REFERENCES auth.users(id),
    token TEXT NOT NULL UNIQUE,
    status TEXT NOT NULL DEFAULT 'pending'
        CHECK (status IN ('pending', 'accepted', 'expired', 'cancelled')),
    expires_at TIMESTAMPTZ NOT NULL DEFAULT (NOW() + INTERVAL '7 days'),
    created_at TIMESTAMPTZ DEFAULT NOW(),
    accepted_at TIMESTAMPTZ
);
```

### API Endpoints

#### POST `/api/team/invite` — Отправить приглашение

**Request:**
```json
{
  "email": "colleague@example.com",
  "locale": "ru"
}
```

**Response (успех):**
```json
{
  "success": true,
  "message": "Приглашение отправлено на colleague@example.com"
}
```

**Response (ошибка — лимит):**
```json
{
  "error": "Достигнут лимит участников команды. Обновите подписку."
}
```

#### GET `/api/team/accept?token=xxx` — Получить информацию о приглашении

**Response:**
```json
{
  "invitation": {
    "email": "colleague@example.com",
    "status": "pending",
    "expires_at": "2025-01-22T10:00:00Z"
  },
  "team": {
    "name": "Команда Петрова",
    "subscription_plan": "standard"
  },
  "inviter": {
    "name": "Ivan Petrov",
    "email": "ivan@example.com"
  }
}
```

#### POST `/api/team/accept` — Принять приглашение

**Request:**
```json
{
  "token": "abc123xyz..."
}
```

**Response (успех):**
```json
{
  "success": true,
  "team": {
    "id": "uuid",
    "name": "Команда Петрова"
  }
}
```

#### DELETE `/api/team/invite` — Отменить приглашение

**Request:**
```json
{
  "invitationId": "uuid"
}
```

#### GET `/api/team` — Получить данные команды

**Response:**
```json
{
  "team": {
    "id": "uuid",
    "name": "Команда Петрова",
    "subscription_plan": "standard",
    "max_members": 2,
    "member_count": 1
  },
  "members": [
    {
      "id": "uuid",
      "user_id": "uuid",
      "role": "owner",
      "joined_at": "2025-01-15T10:00:00Z",
      "profile": {
        "full_name": "Ivan Petrov",
        "email": "ivan@example.com"
      }
    }
  ],
  "pendingInvitations": [
    {
      "id": "uuid",
      "email": "colleague@example.com",
      "created_at": "2025-01-15T12:00:00Z",
      "expires_at": "2025-01-22T12:00:00Z"
    }
  ],
  "userRole": "owner"
}
```

#### DELETE `/api/team/members` — Удалить участника / Выйти из команды

**Request:**
```json
{
  "memberId": "uuid"
}
```

### RLS Политики

```sql
-- Владелец видит свою команду
CREATE POLICY "Owner can view own team" ON teams
    FOR SELECT USING (owner_id = auth.uid());

-- Участники видят команду
CREATE POLICY "Members can view team" ON teams
    FOR SELECT USING (
        id IN (SELECT team_id FROM team_members WHERE user_id = auth.uid())
    );

-- Владелец создаёт приглашения
CREATE POLICY "Owner can create invitations" ON team_invitations
    FOR INSERT WITH CHECK (
        team_id IN (SELECT id FROM teams WHERE owner_id = auth.uid())
    );

-- Приглашённый видит своё приглашение по email
CREATE POLICY "Invitee can view own invitation" ON team_invitations
    FOR SELECT USING (
        email = (SELECT email FROM auth.users WHERE id = auth.uid())
    );

-- Участники видят друг друга
CREATE POLICY "Members can view team members" ON team_members
    FOR SELECT USING (
        team_id IN (SELECT team_id FROM team_members WHERE user_id = auth.uid())
    );

-- Участник может выйти (удалить себя)
CREATE POLICY "Member can leave team" ON team_members
    FOR DELETE USING (user_id = auth.uid() AND role != 'owner');
```

### Ключевые файлы

| Компонент | Путь |
|-----------|------|
| Миграция БД | `/database/migrations/create_team_tables.sql` |
| API приглашений | `/frontend/app/api/team/invite/route.ts` |
| API принятия | `/frontend/app/api/team/accept/route.ts` |
| API участников | `/frontend/app/api/team/members/route.ts` |
| API команды | `/frontend/app/api/team/route.ts` |
| Страница команды | `/frontend/app/[locale]/dashboard/team/page.tsx` |
| Страница приглашения | `/frontend/app/[locale]/team-invite/page.tsx` |
| Email шаблоны | `/frontend/lib/email/notifications.ts` |
| Лимиты подписок | `/frontend/lib/subscription.ts` |

---

## ЧТО НЕ РЕАЛИЗОВАНО (Roadmap)

### Критичные доработки

| Функция | Статус | Приоритет |
|---------|--------|-----------|
| Уведомление владельца о принятии приглашения | ❌ Не реализовано | Высокий |
| Повторная отправка истёкшего приглашения | ❌ Не реализовано | Высокий |
| Rate limiting на endpoint приглашений | ❌ Не реализовано | Высокий |

### Желательные улучшения

| Функция | Статус | Приоритет |
|---------|--------|-----------|
| Массовое приглашение (несколько email) | ❌ Не реализовано | Средний |
| Передача владения командой | ❌ Не реализовано | Средний |
| Разные роли (admin, viewer, editor) | ❌ Не реализовано | Низкий |
| Аудит-лог действий команды | ❌ Не реализовано | Низкий |
| Хэширование токенов приглашений | ❌ Не реализовано | Низкий |

---

## Диаграмма процесса

```
┌─────────────────────────────────────────────────────────────────────────┐
│                         FLOW ПРИГЛАШЕНИЯ В КОМАНДУ                      │
└─────────────────────────────────────────────────────────────────────────┘

     ВЛАДЕЛЕЦ                         СИСТЕМА                      ПРИГЛАШЁННЫЙ
         │                               │                              │
         │  1. Нажимает "Пригласить"     │                              │
         │──────────────────────────────>│                              │
         │                               │                              │
         │  2. Вводит email коллеги      │                              │
         │──────────────────────────────>│                              │
         │                               │                              │
         │                               │  3. Проверяет лимиты         │
         │                               │     подписки                 │
         │                               │                              │
         │                               │  4. Генерирует токен         │
         │                               │     (64 символа)             │
         │                               │                              │
         │                               │  5. Сохраняет в БД           │
         │                               │     (срок: 7 дней)           │
         │                               │                              │
         │                               │  6. Отправляет email ───────>│
         │                               │                              │
         │  7. Видит "Ожидающие         │                              │
         │     приглашения"              │                              │
         │<──────────────────────────────│                              │
         │                               │                              │
         │                               │      8. Получает письмо      │
         │                               │<─────────────────────────────│
         │                               │                              │
         │                               │      9. Переходит по ссылке  │
         │                               │<─────────────────────────────│
         │                               │                              │
         │                               │  10. Проверяет               │
         │                               │      авторизацию             │
         │                               │                              │
         │                               │      11. Показывает детали   │
         │                               │          приглашения ───────>│
         │                               │                              │
         │                               │      12. Нажимает "Принять"  │
         │                               │<─────────────────────────────│
         │                               │                              │
         │                               │  13. Проверяет email         │
         │                               │      и срок действия         │
         │                               │                              │
         │                               │  14. Добавляет в             │
         │                               │      team_members            │
         │                               │                              │
         │                               │  15. Обновляет статус        │
         │                               │      → 'accepted'            │
         │                               │                              │
         │  16. Видит нового участника   │      17. Видит Dashboard ───>│
         │<──────────────────────────────│          команды             │
         │                               │                              │
         ▼                               ▼                              ▼
```

---

## FAQ

**Q: Может ли участник видеть данные до своего приглашения?**
A: Да, участник видит все исторические данные команды.

**Q: Что происходит, если участник выходит из команды?**
A: Создаётся новая персональная команда, он теряет доступ к данным прежней команды.

**Q: Можно ли быть участником нескольких команд?**
A: Нет, пользователь может состоять только в одной команде.

**Q: Что происходит с подпиской, если владелец удалит аккаунт?**
A: Все участники теряют доступ (каскадное удаление). Рекомендуется сначала передать данные.

**Q: Как перенести данные из личного аккаунта в команду?**
A: Пока нет автоматического механизма. Нужно вручную создать объекты заново.
